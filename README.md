> # Inception

This project aims to virtualize several Docker images and create a network of containers for a WordPress website. The following containers are created:

* A Docker container with NGINX with TLSv1.2 or TLSv1.3 only [Details](#nginx-container)
* A Docker container with WordPress + php-fpm
* A Docker container with MariaDB
* A volume that contains the WordPress database
* A second volume that contains the WordPress website files
* A docker-network that establishes the connection between the containers

## Getting Started

This project consists in having you set up a small infrastructure composed of different
services under specific rules. The whole project has to be done in a virtual machine. You
have to use `docker compose`

* Docker installed on your machine
* Familiarity with basic Docker concepts and commands

## Table of Contents

1. [X] [Docker](#Docker)
2. [X] [Docker Images](#docker-Images)
3. [X] [Docker Containers](#docker-Containers)
4. [X] [Docker Volumes](#docker-volumes)
5. [X] [Docker Network](#docker-network)
6. [X] [Docker Compose](#docker-compose)
7. [X] [NGINX Container](#nginx-container)
8. [X] [WordPress Container](https://github.com/mmasstou/Inception/tree/master/srcs/requirements/wordpress)
9. [X] [MariaDB Container](#mariadb-container)

## Docker

 Docker is a software platform that allows you to create, deploy, and run applications inside containers. Containers are isolated environments that include all the necessary files and dependencies needed to run an application, making it easy to deploy and manage applications across different environments. Docker provides a standardized and reproducible way to package and distribute applications, making it easier for developers to create, test, and deploy their applications.

## Docker Images

A Docker image is a pre-built environment for running a containerized application, consisting of all necessary files, libraries, and configuration settings packaged into a single file system

## Docker Containers

A Docker container is a runnable instance of a Docker image, isolated from the host system and its resources, with its own file system, network, and process space.

## Docker Volumes

A Docker volume is a way to store data generated by and/or used by a Docker container, that persist even after the container is deleted. Volumes can be created and managed independently of containers, and can be used by multiple containers.

## Docker Network

A Docker network is a virtual network that connects Docker containers, allowing them to communicate with each other and the host system, as well as to isolate network traffic between containers.

## Docker Compose

Docker Compose is a tool for defining and running multi-container Docker applications, by using a YAML file to specify the services, networks, and volumes for an application, and to configure how they are connected and interact with each other. With Docker Compose, you can define an entire application stack in a single file, and then start and stop the entire stack with a single command.

# Diagram of the Expected Result

# Containers :

## NGINX Container

The NGINX container contains the NGINX web server with TLSv1.2 or TLSv1.3 only.

Folder File :

* `conf/nginx.conf`
* `Dockerfile`

INSTALL :

```
FROM debian:buster

RUN apt-get update && apt-get install -y nginx openssl
RUN openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/mmasstou.key -out /etc/ssl/certs/mmasstou.crt -subj="/C=MA/ST=rabat/O=./CN=mmasstou.42.fr"
EXPOSE 443
CMD ["nginx", "-g", "daemon off;"]
```

* `FROM debian:buster ` : The image is based on the latest version of Debian Buster.
* `RUN apt-get update && apt-get install -y nginx openssl ` : The `RUN` command updates the package list and installs Nginx and OpenSSL.
* `RUN openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/mmasstou.key -out /etc/ssl/certs/exemple.crt -subj="/C=MA/ST=rabat/O=./CN=exemple.42.fr" ` : The `RUN` command generates a self-signed SSL certificate for use with the Nginx server.
* `EXPOSE 443 ` : The `EXPOSE` directive specifies that the Nginx server will listen on port 443.
* `CMD ["nginx", "-g", "daemon off;"] ` : The `CMD` command starts the Nginx server in the foreground.

## WordPress Container

The WordPress container contains WordPress and php-fpm, installed and configured without NGINX.

Folder File :

* `conf/www.conf`
* `tools/wp_config.sh`
* `Dockerfile`

> wp_config.sh

```
#!/bin/bash

echo "WP -- Configuration"

if [ ! -f /var/www/html/wordpress/wp-config.php ]; then
    echo "WP -- '/var/www/html/wordpress/wp-config.php' file does not exist"
    echo "WP --  download wordpress files"
    wp core download --allow-root --path=/var/www/html/wordpress
    # We create a new wp-config.php file (= wordpress configuration file) with MYSQL_USER
    # echo "Wordpress: We install WordPress with WORDPRESS_ADMIN_USER"
    echo "WP --  Create '/var/www/html/wordpress/wp-config.php' file "
    wp config create --dbname=${DATABASE_NAME} --dbuser=${DATABASE_USER} --dbpass=${DATABASE_PWD} --dbhost=mariadb --path=/var/www/html/wordpress  --allow-root
    echo "WP --  set Redis Vars"
    wp config set WP_REDIS_HOST "${WP_REDIS_HOST}" --path=/var/www/html/wordpress  --allow-root --type=constant
    wp config set WP_REDIS_PORT "${WP_REDIS_PORT}"  --path=/var/www/html/wordpress  --allow-root --type=constant
    # We install WordPress with WORDPRESS_ADMIN_USER
    echo "WP --  install WordPress with $WP_ADMIN"
    wp core install --url=${DOMAIN_NAME} --title=${WP_TITLE} --admin_user=${WP_ADMIN} --admin_password=${WP_ADMIN_PASSWORD} --admin_email=${WP_ADMIN_EMAIL} --skip-email  --path=/var/www/html/wordpress --allow-root
    # We create a wordpress simple user
    echo "WP --  create a wordpress user : $WP_USER"
    wp user create ${WP_USER} ${WP_USER_EMAIL}  --user_pass=${WP_USER_PASSWORD} --role=author --path=/var/www/html/wordpress --allow-root
    # echo "Wordpress: We install a theme 'inspiro'"
    echo "WP --  install  Redis-cache"
    wp plugin install redis-cache --allow-root --path=/var/www/html/wordpress  --activate
    echo "WP --  set WP_CACHE true in config file"
    wp config set WP_CACHE true --path=/var/www/html/wordpress  --allow-root --type=constant
    echo "WP --  end of configrations"
    echo "WP --  Enable redis"
    wp redis enable --path=/var/www/html/wordpress --allow-root
fi

exec "$@"
```

`if [ ! -f /var/www/html/wordpress/wp-config.php ]; then ` : The script is checking if the file "/var/www/html/wordpress/wp-config.php" exists. If it doesn't, it performs a series of WordPress CLI (wp) commands

> Dockerfile :

```
FROM debian:buster
RUN apt-get update && apt-get install -y mariadb-server \
    php \
    php-fpm \
    php-mysql \
    wget \
    unzip \
    curl
# install Wordpress CLI and put in the Folder : /usr/local/bin/wp
RUN curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && chmod +x wp-cli.phar && mv wp-cli.phar /usr/local/bin/wp

# create /run/php :
# create /var/www/html : 
RUN mkdir /run/php && mkdir -p /var/www/html && chmod +x /var/www/html
# copy the script to `/tmp/` to execute in container  and www.conf to `/etc/php/7.3/fpm/pool.d/` to update the config of fpm
COPY ./tools/wp_config.sh  /tmp/wp_config.sh
COPY ./conf/www.conf /etc/php/7.3/fpm/pool.d/www.conf

RUN chmod +x /tmp/wp_config.sh 


ENTRYPOINT [ "/tmp/wp_config.sh"]

CMD ["php-fpm7.3", "-F"]
```

* `FROM debian:buster ` : The image is based on the latest version of Debian Buster.
* `RUN apt-get update && apt-get install -y mariadb-server \ php \ php-fpm \ php-mysql \ wget \ unzip \ curl ` : The `RUN` command updates the package list and installs the necessary packages for running a PHP-FPM and MariaDB setup, including PHP, MariaDB server, PHP-MySQL, wget, unzip, and curl.
* `RUN curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && chmod +x wp-cli.phar && mv wp-cli.phar /usr/local/bin/wp ` : The `RUN` command also installs the WordPress CLI and puts it in the `/usr/local/bin` folder.
* `RUN mkdir /run/php && mkdir -p /var/www/html && chmod +x /var/www/html ` : The `RUN` command creates the necessary directories `/run/php` and `/var/www/html`, and sets the proper permissions.
* `COPY ./tools/wp_config.sh  /tmp/wp_config.sh ` `COPY ./conf/www.conf /etc/php/7.3/fpm/pool.d/www.conf` : The `COPY` command copies a shell script `wp_config.sh` and a PHP-FPM pool configuration file `www.conf` to the container.
* `RUN chmod +x /tmp/wp_config.sh ` : The `RUN` command makes the shell script executable.
* `ENTRYPOINT [ "/tmp/wp_config.sh"] ` : The `ENTRYPOINT` directive specifies the shell script to be executed when the container is started.
* `CMD ["php-fpm7.3", "-F"] ` : The `CMD` command starts the PHP-FPM process in the foreground.

## MariaDB Container

The MariaDB container contains the MariaDB database server, without NGINX.

## Volumes

There are two volumes in this project:

- A volume that contains the WordPress database
- A volume that contains the WordPress website files

## Docker Network

The Docker network in this project connects the containers.

For more information on how to build these containers, please refer to the [Code](#code) section.

## Code

To build the containers, follow the steps in the [Code](#code) section of this `README.md` file.
